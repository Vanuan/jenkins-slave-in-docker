version: '3.2'
services:
  jenkins-slave:
    image: 'sizmek/jenkins-slave-in-docker'
    hostname: jenkins-slave-in-docker
    ports:
      - target: 22
        published: 9022
        protocol: tcp
        mode: host
    volumes:
      - /etc/ssh/authorized-keys/jenkins.pub:/jenkins.pub:ro
      - /srv/docker-jenkins:/srv/jenkins
      - /srv/jenkins/workspace:/srv/jenkins/workspace
      - /srv/jenkins/.ssh/:/host-ssh/:ro
      - ./ssh:/etc/ssh
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      DOCKER_GID: $DOCKER_GID
    secrets:
      - db_secrets
    deploy:
      mode: global
      restart_policy:
        condition: any

  docker-system-prune:
    image: softonic/docker-system-prune
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    deploy:
      mode: global
      restart_policy:
        condition: any
        delay: 3600s
        max_attempts: 3650

secrets:
  db_secrets:
    external: true
